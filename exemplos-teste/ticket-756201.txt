TICKET #756201
Data: 05/02/2025
Prioridade: Baixa
Status: Resolvido

PROBLEMA:
Usuário solicitou funcionalidade para buscar tickets pelo número na interface de chat, para facilitar consultas sobre problemas anteriores e suas soluções.

Requisito:
- Adicionar campo/botão para pesquisar por número de ticket
- Ao informar número (ex: 588594), sistema deve buscar documento relacionado
- Usar documento do ticket como contexto para responder perguntas
- Implementação simples e rápida para MVP

CONTEXTO:
Os tickets são armazenados como arquivos TXT com nomenclatura "ticket-[número].txt" (ex: ticket-588594.txt, ticket-392847.txt). A ideia é permitir que desenvolvedores busquem informações sobre tickets resolvidos anteriormente para auxiliar na resolução de novos problemas similares.

ANÁLISE:
Como já temos a infraestrutura de RAG funcionando, a solução mais simples seria:

1. Adicionar um componente de input para número do ticket
2. Criar query SQL que busca documentos pelo padrão no fileName
3. Usar o documento encontrado como contexto para o chat
4. Não precisa criar novas colunas no banco (abordagem MVP)

SOLUÇÃO IMPLEMENTADA:

1. Componente TicketNumberInput (components/ticket-number-input.tsx):
   - Popover com input para digitar número
   - Mostra badge quando ticket está selecionado
   - Botão para limpar seleção

2. Query de busca (lib/db/queries/documents.ts):
   ```typescript
   export async function findDocumentByTicketNumber(ticketNumber: string) {
     const results = await db
       .select()
       .from(documents)
       .where(
         sql`LOWER(${documents.fileName}) LIKE ${`%ticket%${ticketNumber}%`}`
       )
       .orderBy(desc(documents.createdAt))
       .limit(1);
     return results[0] || null;
   }
   ```

3. Server Action (lib/actions/documents.ts):
   - findDocumentByTicketNumberAction() para uso no client component
   - Validação e tratamento de erros

4. Integração no Chat (components/chat.tsx):
   - State ticketNumber
   - Busca documento quando ticket é informado
   - Usa documento como contexto para RAG
   - Placeholder dinâmico: "Faça uma pergunta sobre o ticket #[número]..."

FLUXO DE USO:
1. Usuário faz upload de "ticket-588594.txt"
2. No chat, clica em "Buscar ticket"
3. Digite "588594" e clica "Aplicar"
4. Sistema busca documento com "ticket" e "588594" no nome
5. Usuário pergunta: "Qual foi a solução deste ticket?"
6. Sistema responde usando conteúdo do ticket como contexto

VANTAGENS DA ABORDAGEM:
- Sem mudanças no schema do banco
- Usa infraestrutura existente de RAG
- Busca flexível por padrão no nome
- Implementação rápida (~30 minutos)
- Fácil de testar e validar

TESTES REALIZADOS:
- Build compilou sem erros
- Componente renderiza corretamente
- Busca encontra tickets pelo padrão
- Integração com chat funcionando
- Mensagem de erro apropriada quando ticket não existe

ARQUIVOS MODIFICADOS:
- components/ticket-number-input.tsx (novo)
- components/chat.tsx (modificado)
- lib/db/queries/documents.ts (modificado)
- lib/actions/documents.ts (modificado)

PRÓXIMOS PASSOS (futuro):
- Adicionar autocomplete com lista de tickets
- Histórico de tickets buscados recentemente
- Busca por múltiplos tickets simultaneamente
- Comparação entre soluções de tickets diferentes

FEEDBACK DO USUÁRIO:
Aguardando testes em ambiente de desenvolvimento.
