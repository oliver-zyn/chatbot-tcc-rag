Regras de C√°lculo de Desconto (Sponte Pay / Pagar.me)

Este documento descreve como os descontos (Bolsa Curso, Bolsa Plano e Desconto Manual) s√£o combinados e calculados para boletos Sponte Pay (API Pagar.me).

üõ† 1. Os Tr√™s Tipos de Desconto

Existem tr√™s fontes principais de desconto que podem ser aplicadas a uma Conta a Receber:
* Desconto Curso (Bolsa): Configurado no cadastro do curso (ex: 10% 10 dias antes, 6% 5 dias antes)[cite: 76, 131, 160].
* Desconto Plano (Bolsa): Configurado no plano financeiro do aluno (ex: 14% 15 dias antes)[cite: 30, 48, 77, 132, 161].
* Desconto Manual: Um desconto (ex: 10%) aplicado manualmente na Conta a Receber, geralmente "At√© o Vencimento"[cite: 19, 32, 58, 80, 107, 162].

üõ† 2. Regra Principal: A Soma (Dias Iguais)

A regra de c√°lculo mais importante √©: **Se os descontos (Curso, Plano e Manual) possuem datas de vencimento iguais (ex: "15 dias antes"), seus valores s√£o SOMADOS**[cite: 150].

* Exemplo (Cen√°rio 6):
    * Desconto Curso: 16% (15 dias antes) [cite: 131]
    * Desconto Plano: 14% (15 dias antes) [cite: 135]
    * Resultado: 30% de desconto (15 dias antes)[cite: 137].

* Exemplo (Cen√°rio 7 - "Megazord"):
    * Desconto Curso: 16% (15 dias antes) [cite: 160]
    * Desconto Plano: 14% (15 dias antes) [cite: 161]
    * Desconto Manual: 10% (At√© o vencimento, que se aplica a todos os dias) [cite: 162]
    * Resultado: 40% de desconto (15 dias antes)[cite: 164, 166].

üõ† 3. Regra "Top 3" (Dias Diferentes)

Se os descontos (Curso e Plano) possuem dias de vencimento *diferentes*, o sistema considera apenas os **"top 3 descontos mais distantes"** do vencimento[cite: 251].

* Exemplo (Cen√°rio 10):
    * Curso: 16% (15d), 12% (11d), 6% (5d) [cite: 244, 245]
    * Plano: 15% (15d), 9% (10d), 5% (6d) [cite: 246, 247, 248]
    * Os 3 dias mais distantes s√£o 15d, 11d e 10d. Os outros s√£o ignorados[cite: 251].
    * O sistema ent√£o aplica a "Regra da Soma" (Regra 1) aos "Top 3":
    * Info 1 (15d): 16% (Curso) + 15% (Plano) = 31%[cite: 253, 254].
    * Info 2 (11d): 12% (Curso) = 12%[cite: 258].
    * Info 3 (10d): 9% (Plano) = 9%[cite: 262].

* Exce√ß√£o (Cen√°rio 12 e 13): Se houver apenas *um* tipo de desconto (s√≥ Curso ou s√≥ Plano), a regra do "Top 3" n√£o se aplica; o sistema apenas ordena todos os descontos por data[cite: 292, 317].

üõ† 4. Regras Especiais e Exce√ß√µes

* Regra do "Desconto 0 dias": Um desconto configurado como "0 dias antes do vencimento" age exatamente como um "Desconto Manual", ou seja, ele se soma a todos os outros descontos e se aplica "At√© o Vencimento"[cite: 195, 205, 222, 230, 236].
* Regra do "Checkbox Lan√ßar com desconto": H√° um checkbox "Lan√ßar parcelas com o desconto da bolsa"[cite: 81]. Se esta op√ß√£o for marcada:
    1. O desconto √© aplicado *diretamente* no valor da parcela e "n√£o indo para Pagar.me"[cite: 81].
    2. (Cen√°rio 5) Se a checkbox estiver marcada *e* o plano tiver m√∫ltiplos descontos (ex: 10d e 5d), o sistema ignora a soma e considera **apenas o primeiro desconto** (o mais pr√≥ximo do vencimento, ex: 5d)[cite: 109, 110].

üõ† 5. Limita√ß√µes da API Pagar.me (Convers√£o e Arredondamento)

* Regra da Convers√£o (R$ para %): A API Pagar.me aceita descontos **apenas em percentual (%)**[cite: 333].
    * Se um desconto √© lan√ßado em Reais (R$) no Sponte (ex: R$ 50,00), o sistema primeiro o converte para percentual (ex: R$ 50,00 / R$ 200,00 = 25%) e envia os 25% para a Pagar.me [cite: 335-343].
* Regra do Arredondamento (Centavos): A API Pagar.me tem uma limita√ß√£o de **2 casas decimais** para o percentual de desconto[cite: 357].
    * Isso pode causar um **truncamento**. Ex: um desconto de R$ 200,00 em R$ 1200,00 √© 16,6666...%[cite: 367]. O sistema trunca para 16,66%[cite: 364].
    * Ao aplicar 16,66% em R$ 1200,00, o desconto final ser√° de R$ 199,92 (e n√£o R$ 200,00)[cite: 369, 350, 351]. Essa varia√ß√£o de centavos √© esperada[cite: 357].